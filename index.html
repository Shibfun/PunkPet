<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PunkPet - Collect</title>
    <link rel="icon" href="images/1.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FF9100;
            --secondary-color: #FFFFFF;
            --background-color: #1C2526;
            --card-bg: #2D383A;
            --text-color: #FF9100;
            --header-text-color: #FFFFFF;
            --border-radius: 10px;
            --pixel-border: 2px solid #FF9100;
            --shadow: 0 4px 12px rgba(255, 145, 0, 0.4);
            --transition-speed: 0.3s;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comic Neue', cursive;
        }
        body {
            background: var(--background-color);
            color: var(--text-color);
            padding: 15px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            background: var(--card-bg);
            border: var(--pixel-border);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .header {
            background: var(--primary-color);
            padding: 15px;
            border: var(--pixel-border);
            border-radius: var(--border-radius);
            text-align: center;
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--header-text-color);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .header img {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            image-rendering: pixelated;
        }
        .connect-section {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        .connect-section button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--secondary-color);
            border: var(--pixel-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: transform var(--transition-speed), background var(--transition-speed);
            box-shadow: var(--shadow);
            max-width: 180px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .connect-section button:hover {
            background: #E67E00;
            transform: translateY(-2px);
        }
        .connect-section button:disabled {
            background: #555555;
            cursor: not-allowed;
            transform: none;
        }
        .filter-section {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
            animation: fadeIn var(--transition-speed) ease-in;
        }
        .filter-section button {
            padding: 8px 15px;
            background: var(--primary-color);
            color: var(--secondary-color);
            border: var(--pixel-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 12px;
            transition: transform var(--transition-speed), background var(--transition-speed);
            box-shadow: var(--shadow);
        }
        .filter-section button:hover {
            background: #E67E00;
            transform: translateY(-2px);
        }
        .filter-section button.active {
            background: #555555;
            transform: none;
        }
        .pets-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
            opacity: 0;
            animation: fadeIn var(--transition-speed) ease-in;
        }
        .pet-card {
            background: var(--card-bg);
            border: var(--pixel-border);
            border-radius: var(--border-radius);
            text-align: center;
            padding: 12px;
            box-shadow: var(--shadow);
            transition: transform var(--transition-speed), opacity var(--transition-speed);
            position: relative;
            overflow: hidden;
        }
        .pet-card:hover {
            transform: translateY(-3px);
        }
        .pet-card img {
            width: 48px;
            height: 48px;
            margin: 0 auto 10px;
            border: 2px solid #FF9100;
            border-radius: 5px;
            image-rendering: pixelated;
        }
        .pet-card .pet-id, .pet-card .pet-info {
            font-size: 12px;
            margin-bottom: 6px;
            color: var(--text-color);
        }
        .pet-card .progress-bar {
            width: 100%;
            height: 4px;
            background: #444;
            margin-top: 5px;
            border-radius: 2px;
            overflow: hidden;
        }
        .pet-card .progress {
            height: 100%;
            background: var(--primary-color);
            transition: width var(--transition-speed);
        }
        .pet-card button {
            padding: 6px;
            background: var(--primary-color);
            color: var(--secondary-color);
            border: var(--pixel-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 10px;
            width: 100%;
            margin: 4px 0;
            transition: transform var(--transition-speed), background var(--transition-speed);
            box-shadow: var(--shadow);
        }
        .pet-card button:hover:not(:disabled) {
            background: #E67E00;
            transform: translateY(-2px);
        }
        .pet-card button:disabled {
            background: #555555;
            cursor: not-allowed;
            transform: none;
        }
        .pet-card button.selected {
            background: #888888;
            color: #CCCCCC;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            animation: fadeIn var(--transition-speed) ease-in;
        }
        .modal-content {
            background: var(--card-bg);
            margin: 10% auto;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            border: var(--pixel-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow-y: auto;
            max-height: 70vh;
        }
        .feed-section {
            margin-top: 20px;
            text-align: center;
        }
        .feed-section button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--secondary-color);
            border: var(--pixel-border);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: transform var(--transition-speed), background var(--transition-speed);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        .feed-section button:hover:not(:disabled) {
            background: #E67E00;
            transform: translateY(-2px);
        }
        .feed-section button:disabled {
            background: #555555;
            cursor: not-allowed;
            transform: none;
        }
        .feed-section .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 3px solid #fff;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }
        .feed-section .status {
            margin-top: 10px;
            font-size: 12px;
            color: var(--primary-color);
        }
        .dog-section {
            text-align: center;
            margin-top: 20px;
        }
        .dog-section img {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
            border: 2px solid #FF9100;
            border-radius: 8px;
            image-rendering: pixelated;
        }
        .dog-message {
            font-size: 14px;
            color: var(--primary-color);
            font-style: italic;
            transition: opacity var(--transition-speed);
        }
        .token-item {
            display: flex;
            align-items: center;
            padding: 12px;
            cursor: pointer;
            border-radius: var(--border-radius);
            margin: 5px 0;
            transition: background var(--transition-speed);
        }
        .token-item:hover {
            background: #2A2A2A;
        }
        .token-item img {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            border: 2px solid #FF9100;
            border-radius: 5px;
            image-rendering: pixelated;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        @media (max-width: 480px) {
            body { padding: 8px; }
            .container { padding: 10px; }
            .header { font-size: 18px; }
            .header img { width: 30px; height: 30px; }
            .pets-section { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; }
            .pet-card img { width: 36px; height: 36px; }
            .pet-card .pet-id, .pet-card .pet-info { font-size: 10px; }
            .pet-card button { font-size: 9px; padding: 5px; }
            .dog-section img { width: 40px; height: 40px; }
            .connect-section { flex-direction: column; }
            .filter-section { flex-direction: column; gap: 5px; }
            .modal-content { margin: 15% auto; max-width: 300px; }
            .connect-section button, .feed-section button { font-size: 12px; padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><img src="images/1.png" alt="PunkPet Logo">PunkPet</div>
        <div class="connect-section">
            <button id="connectWalletButton">Connect Wallet</button>
        </div>
        <div class="filter-section">
            <button id="filterAll" class="active">All</button>
            <button id="filterMine">Mine</button>
        </div>
        <div class="pets-section" id="petsSection"></div>
        <div class="feed-section">
            <button id="feedButton" onclick="feedPets()" disabled>
                <span>Feed Pets</span>
                <div class="loading" id="feedLoading" style="display:none;"></div>
            </button>
            <div id="feedStatus" class="status"></div>
        </div>
        <div class="dog-section">
            <img src="images/1.png" alt="Shiba Dog">
            <div class="dog-message" id="dogMessage">"Hey punk, connect your wallet to dive in!"</div>
        </div>
    </div>
    <div class="modal" id="tokenModal">
        <div class="modal-content">
            <h3>Select Pets to Feed</h3>
            <div id="feedPetList"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        const contractAddress = "0x4C77aD12C8aa89CB4c413B4938E119d35Cb4cb00";
        const contractAbi = [
            {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256[]","name":"petIds","type":"uint256[]"}],"name":"batchPurchasePet","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256[]","name":"petIds","type":"uint256[]"}],"name":"batchFeedPet","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"petId","type":"uint256"}],"name":"giftPet","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"withdrawNONE","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"withdrawFEED","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"startId","type":"uint256"},{"internalType":"uint256","name":"endId","type":"uint256"}],"name":"getUserPetsPaginated","outputs":[{"internalType":"uint256[]","name":"petIds","type":"uint256[]"},{"internalType":"uint256[]","name":"counts","type":"uint256[]"},{"internalType":"uint256[]","name":"nextFeedTimes","type":"uint256[]"},{"internalType":"uint256[]","name":"feedCounts","type":"uint256[]"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserTotalPets","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"petId","type":"uint256"}],"name":"getPetPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256[]","name":"petIds","type":"uint256[]"}],"name":"getPetPrices","outputs":[{"internalType":"uint256[]","name":"prices","type":"uint256[]"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"petId","type":"uint256"}],"name":"getFeedCost","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"pure","type":"function"},
            {"inputs":[{"internalType":"uint256[]","name":"petIds","type":"uint256[]"}],"name":"getFeedCosts","outputs":[{"internalType":"uint256[]","name":"costs","type":"uint256[]"}],"stateMutability":"pure","type":"function"}
        ];
        const shibarium = {
            chainId: 109,
            chainName: 'Shibarium',
            nativeCurrency: { name: 'BONE', symbol: 'BONE', decimals: 18 },
            rpcUrls: ['https://rpc.shibrpc.com'],
            blockExplorerUrls: ['https://shibariumscan.io']
        };
        let web3, account, contract;
        let selectedPets = [];
        let filterMode = 'all';
        let petPrices = {};

        const dogMessages = {
            connectStart: ["Yo punk, jacking into your wallet, hold tight!","Scanning the blockchain for your creds, stay sharp!","Plugging into Shibarium, let’s roll, rebel!","Hacking your wallet vibes, keep it real!"],
            connectSuccess: ["Hell yeah, you’re in, punk master!","Wallet’s live, time to dominate, rebel!","Shibarium’s ours, let’s punk it up!","Connected, punk legend, let’s cause chaos!"],
            connectFail: ["Damn, wallet slipped, try again, punk!","No creds detected, get back in the game!","Glitch in the system, retry, rebel!","Wallet’s ghosting us, dig it out!","No wallet detected. Install MetaMask.","No accounts found. Unlock your wallet."],
            purchaseStart: ["Snatching pets, hold on, punk!","Grabbing those pixels, stay cool, rebel!","Collecting chaos, let’s punk it!","Buying spree, punk style, hang tight!"],
            purchaseSuccess: ["Pets secured, you’re a punk legend!","Pixels owned, total rebel victory!","You’ve claimed ‘em, punk king!","Purchase complete, chaos unleashed!"],
            purchaseFail: ["Buy failed, punk, retry!","No NONE, hit the grind again!","Chain glitched, punk it up again!","Purchase crashed, fight harder!"],
            feedStart: ["Feeding frenzy, hold on, punk!","Nourishing pixels, stay sharp, rebel!","Feeding time, punk chaos incoming!","Powering up pets, punk style!"],
            feedSuccess: ["Pets fed, you’re a punk pro!","Pixels powered, rebel win!","Feeding done, punk hero status!","Pets thriving, punk domination!"],
            feedFail: ["Feeding crashed, retry, punk!","No FEED, hit the grind, rebel!","Feed glitched, punk it up!","Feeding failed, dig deeper!"],
            insufficientBalance: ["NONE’s low, punk, stack more!","Need more NONE, rebel, hustle!","Wallet’s dry, punk, earn some!","NONE’s gone, get back in the game!"],
            insufficientFeed: ["FEED’s low, punk, stock up!","Need more FEED, rebel, grind!","FEED’s out, punk, refill!","FEED’s gone, hit the streets!"]
        };

        function getRandomMessage(type) {
            const messages = dogMessages[type];
            return messages[Math.floor(Math.random() * messages.length)];
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('connectWalletButton').addEventListener('click', connectWallet);
            document.getElementById('feedButton').addEventListener('click', feedPets);
            document.getElementById('filterAll').addEventListener('click', () => setFilter('all'));
            document.getElementById('filterMine').addEventListener('click', () => setFilter('mine'));
            setupWalletListeners();
            initializePets();
            fetchAllPrices();
        });

        async function connectWallet() {
            const connectButton = document.getElementById('connectWalletButton');
            const dogMessage = document.getElementById('dogMessage');
            try {
                if (!window.ethereum) throw new Error("No wallet detected. Install MetaMask.");
                connectButton.disabled = true;
                dogMessage.innerText = getRandomMessage('connectStart');
                web3 = new Web3(window.ethereum);
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts.length) throw new Error("No accounts found. Unlock your wallet.");
                account = accounts[0];
                await switchToShibarium();
                contract = new web3.eth.Contract(contractAbi, contractAddress);
                updateUIAfterConnect();
                updatePets();
            } catch (error) {
                dogMessage.innerText = getRandomMessage('connectFail') + (error.message ? " " + error.message : "");
                resetUI();
            } finally {
                connectButton.disabled = false;
            }
        }

        async function switchToShibarium() {
            const chainId = await web3.eth.getChainId();
            if (Number(chainId) !== 109) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: "0x6d" }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [shibarium]
                        });
                    } else {
                        throw switchError;
                    }
                }
            }
        }

        function updateUIAfterConnect() {
            const connectButton = document.getElementById('connectWalletButton');
            const dogMessage = document.getElementById('dogMessage');
            connectButton.textContent = `Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;
            dogMessage.innerText = getRandomMessage('connectSuccess');
            document.getElementById('feedButton').disabled = false;
        }

        function resetUI() {
            const connectButton = document.getElementById('connectWalletButton');
            connectButton.textContent = "Connect Wallet";
            document.getElementById('feedButton').disabled = true;
        }

        function setupWalletListeners() {
            if (!window.ethereum) return;
            window.ethereum.on('accountsChanged', async (newAccounts) => {
                if (newAccounts.length) {
                    account = newAccounts[0];
                    if (web3) {
                        await switchToShibarium();
                        contract = new web3.eth.Contract(contractAbi, contractAddress);
                        updateUIAfterConnect();
                        updatePets();
                    } else {
                        await connectWallet();
                    }
                } else {
                    web3 = null;
                    account = null;
                    contract = null;
                    resetUI();
                    document.getElementById('dogMessage').innerText = getRandomMessage('connectFail');
                }
            });
            window.ethereum.on('chainChanged', async (chainId) => {
                if (parseInt(chainId, 16) !== 109) {
                    web3 = null;
                    account = null;
                    contract = null;
                    resetUI();
                    document.getElementById('dogMessage').innerText = "Wrong chain, punk! Switch to Shibarium!";
                } else if (account) {
                    await connectWallet();
                }
            });
        }

        function initializePets() {
            const petsSection = document.getElementById('petsSection');
            for (let i = 1; i <= 77; i++) {
                const petCard = document.createElement('div');
                petCard.className = 'pet-card';
                petCard.id = `pet-${i}`;
                const imgSrc = `images/${i}.png`;
                petCard.innerHTML = `
                    <img src="${imgSrc}" alt="Pet #${i}" onerror="this.src='images/1.png';">
                    <div class="pet-id">Pet #${i}</div>
                    <div class="pet-info">Price: 0.00 NONE</div>
                    <div class="pet-info">My: 0</div>
                    <div class="pet-info">Feed: No</div>
                    <div class="pet-info">Next Feed: Now</div>
                    <div class="progress-bar"><div class="progress" style="width: 0%;"></div></div>
                `;
                const selectButton = document.createElement('button');
                selectButton.id = `selectPet-${i}`;
                selectButton.textContent = 'Select';
                selectButton.onclick = () => toggleSelectPet(i);
                selectButton.disabled = true;
                const buyButton = document.createElement('button');
                buyButton.id = `buyButton-${i}`;
                buyButton.textContent = 'Buy';
                buyButton.onclick = () => purchasePet(i);
                buyButton.disabled = true;
                const feedButton = document.createElement('button');
                feedButton.id = `feedPet-${i}`;
                feedButton.textContent = 'Feed';
                feedButton.onclick = () => feedPet(i);
                feedButton.disabled = true;
                petCard.appendChild(selectButton);
                petCard.appendChild(buyButton);
                petCard.appendChild(feedButton);
                petsSection.appendChild(petCard);
            }
        }

        async function fetchAllPrices() {
            if (!web3 || !contract) return;
            const petIds = Array.from({ length: 77 }, (_, i) => i + 1);
            petPrices = (await contract.methods.getPetPrices(petIds).call()).reduce((obj, price, index) => {
                obj[index + 1] = price;
                return obj;
            }, {});
        }

        async function updatePets() {
            if (!web3 || !account || !contract) return;
            const totalPets = await contract.methods.getUserTotalPets(account).call().catch(() => 0);
            let userPets = { petIds: [], counts: [], nextFeedTimes: [] };
            try {
                const [petIds, counts, nextFeedTimes] = await contract.methods.getUserPetsPaginated(account, 1, 77).call();
                userPets = { petIds, counts, nextFeedTimes };
            } catch (error) {
                console.error("Error fetching user pets:", error);
            }
            for (let i = 1; i <= 77; i++) {
                const petCard = document.getElementById(`pet-${i}`);
                const price = petPrices[i] || "0";
                const ownedIndex = userPets.petIds.indexOf(i.toString());
                const owned = ownedIndex !== -1 ? userPets.counts[ownedIndex] : 0;
                const canFeed = owned > 0 && (ownedIndex === -1 || (new Date().getTime() / 1000 >= Number(userPets.nextFeedTimes[ownedIndex])));
                const nextFeedTime = ownedIndex !== -1 ? Number(userPets.nextFeedTimes[ownedIndex]) : 0;
                const timeUntilNextFeed = canFeed || nextFeedTime === 0 ? 0 : (nextFeedTime - Math.floor(Date.now() / 1000)) / (20 * 3600) * 100;
                petCard.innerHTML = `
                    <img src="images/${i}.png" alt="Pet #${i}" onerror="this.src='images/1.png';">
                    <div class="pet-id">Pet #${i}</div>
                    <div class="pet-info">Price: ${web3.utils.fromWei(price, 'ether').substring(0, 8)} NONE</div>
                    <div class="pet-info">My: ${owned}</div>
                    <div class="pet-info">Feed: ${owned > 0 ? (canFeed ? 'Yes' : 'No') : 'No'}</div>
                    <div class="pet-info">Next Feed: ${canFeed ? 'Now' : formatTimeUntil(nextFeedTime)}</div>
                    <div class="progress-bar"><div class="progress" style="width: ${timeUntilNextFeed > 0 ? Math.min(100, timeUntilNextFeed) : 0}%;"></div></div>
                `;
                const selectButton = document.getElementById(`selectPet-${i}`);
                const buyButton = document.getElementById(`buyButton-${i}`);
                const feedButton = document.getElementById(`feedPet-${i}`);
                selectButton.disabled = false;
                buyButton.disabled = owned > 0;
                feedButton.disabled = !canFeed || owned === 0;
                selectButton.textContent = selectedPets.includes(i) ? 'Deselect' : 'Select';
                selectButton.className = selectedPets.includes(i) ? 'selected' : '';
                buyButton.textContent = 'Buy';
                feedButton.textContent = 'Feed';
            }
            updatePetButtons();
            filterPets(userPets.petIds);
        }

        function setFilter(mode) {
            filterMode = mode;
            document.getElementById('filterAll').className = mode === 'all' ? 'active' : '';
            document.getElementById('filterMine').className = mode === 'mine' ? 'active' : '';
            filterPets();
            document.querySelectorAll('.pets-section').forEach(section => {
                section.style.opacity = 0;
                setTimeout(() => section.style.opacity = 1, 50);
            });
        }

        function filterPets(ownedPetIds = []) {
            const pets = document.getElementsByClassName('pet-card');
            for (let pet of pets) {
                const petId = parseInt(pet.id.split('-')[1]);
                if (filterMode === 'mine') {
                    pet.style.display = ownedPetIds.includes(petId) ? 'block' : 'none';
                } else {
                    pet.style.display = 'block';
                }
            }
        }

        function toggleSelectPet(petId) {
            if (!web3 || !account) return;
            const index = selectedPets.indexOf(petId);
            const button = document.getElementById(`selectPet-${petId}`);
            if (index === -1) {
                selectedPets.push(petId);
                button.textContent = 'Deselect';
                button.className = 'selected';
            } else {
                selectedPets.splice(index, 1);
                button.textContent = 'Select';
                button.className = '';
            }
        }

        function formatTimeUntil(nextFeedTime) {
            const now = Math.floor(Date.now() / 1000);
            const secondsUntil = nextFeedTime - now;
            if (secondsUntil <= 0) return "Now";
            const hours = Math.floor(secondsUntil / 3600);
            const minutes = Math.floor((secondsUntil % 3600) / 60);
            const seconds = secondsUntil % 60;
            return `${hours}h ${minutes}m ${seconds}s`;
        }

        async function updatePetButtons() {
            if (!web3 || !account || !contract) return;
            const totalPets = await contract.methods.getUserTotalPets(account).call().catch(() => 0);
            for (let i = 1; i <= 77; i++) {
                const button = document.getElementById(`buyButton-${i}`);
                const price = petPrices[i] || "0";
                const noneBalance = await new web3.eth.Contract(erc20Abi, "0x64E19b6a167878d2483d166212A3c2c68b1eB842").methods.balanceOf(account).call().catch(() => "0");
                button.disabled = totalPets >= 100 || (i === 1 ? false : web3.utils.toBN(noneBalance).lt(web3.utils.toBN(price)));
            }
        }

        async function purchasePet(petId) {
            const dogMessage = document.getElementById('dogMessage');
            const feedButton = document.getElementById('feedButton');
            if (!web3 || !account) {
                dogMessage.innerText = getRandomMessage('connectFail');
                return;
            }
            const petsToBuy = selectedPets.length > 0 ? selectedPets : [petId];
            try {
                dogMessage.innerText = getRandomMessage('purchaseStart');
                feedButton.disabled = true;
                document.getElementById('feedLoading').style.display = 'block';
                const prices = await contract.methods.getPetPrices(petsToBuy).call();
                const totalPrice = prices.reduce((sum, price) => web3.utils.toBN(sum).add(web3.utils.toBN(price)).toString(), 0);
                const noneBalance = await new web3.eth.Contract(erc20Abi, "0x64E19b6a167878d2483d166212A3c2c68b1eB842").methods.balanceOf(account).call();
                if (web3.utils.toBN(noneBalance).lt(web3.utils.toBN(totalPrice))) {
                    dogMessage.innerText = getRandomMessage('insufficientBalance');
                    return;
                }
                const allowance = await new web3.eth.Contract(erc20Abi, "0x64E19b6a167878d2483d166212A3c2c68b1eB842").methods.allowance(account, contractAddress).call();
                if (web3.utils.toBN(allowance).lt(web3.utils.toBN(totalPrice))) {
                    dogMessage.innerText = "Authorizing NONE...";
                    await new web3.eth.Contract(erc20Abi, "0x64E19b6a167878d2483d166212A3c2c68b1eB842").methods.approve(contractAddress, totalPrice).send({ from: account });
                }
                await contract.methods.batchPurchasePet(petsToBuy).send({ from: account });
                selectedPets = [];
                dogMessage.innerText = getRandomMessage('purchaseSuccess');
                updatePets();
            } catch (error) {
                dogMessage.innerText = "Purchase failed: " + (error.message || "Unknown error");
                console.error(error);
            } finally {
                feedButton.disabled = false;
                document.getElementById('feedLoading').style.display = 'none';
            }
        }

        function feedPets() {
            const modal = document.getElementById('tokenModal');
            const feedPetList = document.getElementById('feedPetList');
            const dogMessage = document.getElementById('dogMessage');
            const feedButton = document.getElementById('feedButton');
            if (!web3 || !account) {
                dogMessage.innerText = getRandomMessage('connectFail');
                return;
            }
            modal.style.display = 'block';
            feedPetList.innerHTML = '';
            feedButton.disabled = true;
            document.getElementById('feedLoading').style.display = 'block';
            contract.methods.getUserPetsPaginated(account, 1, 77).call().then(([petIds, counts, nextFeedTimes]) => {
                petIds.forEach((petId, index) => {
                    if (petId > 0 && counts[index] > 0) {
                        const now = Math.floor(Date.now() / 1000);
                        const canFeed = now >= Number(nextFeedTimes[index]);
                        if (canFeed) {
                            const div = document.createElement('div');
                            div.className = 'token-item';
                            const imgSrc = `images/${petId}.png`;
                            div.innerHTML = `<img src="${imgSrc}" alt="Pet #${petId}" onerror="this.src='images/1.png';"><span>Pet #${petId} (x${counts[index]})</span>`;
                            div.onclick = () => feedPet(petId);
                            feedPetList.appendChild(div);
                        }
                    }
                });
                dogMessage.innerText = petIds.length ? "Pick a pet to feed, punk!" : "No pets available to feed.";
                feedButton.disabled = false;
                document.getElementById('feedLoading').style.display = 'none';
            }).catch(error => {
                dogMessage.innerText = "Error loading pets: " + error.message;
                feedButton.disabled = false;
                document.getElementById('feedLoading').style.display = 'none';
                console.error(error);
            });
            modal.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
        }

        async function feedPet(petId) {
            const status = document.getElementById('feedStatus');
            const dogMessage = document.getElementById('dogMessage');
            const modal = document.getElementById('tokenModal');
            const feedButton = document.getElementById('feedButton');
            try {
                status.innerText = "Feeding...";
                dogMessage.innerText = getRandomMessage('feedStart');
                feedButton.disabled = true;
                document.getElementById('feedLoading').style.display = 'block';
                const feedBalance = await new web3.eth.Contract(erc20Abi, "0xe9Cb2D7ADC24Fc59FE00D6C0A0669BDF16805Fe0").methods.balanceOf(account).call();
                const feedCost = await contract.methods.getFeedCost(petId).call();
                if (web3.utils.toBN(feedBalance).lt(web3.utils.toBN(feedCost))) {
                    status.innerText = "Insufficient FEED balance.";
                    dogMessage.innerText = getRandomMessage('insufficientFeed');
                    return;
                }
                const allowance = await new web3.eth.Contract(erc20Abi, "0xe9Cb2D7ADC24Fc59FE00D6C0A0669BDF16805Fe0").methods.allowance(account, contractAddress).call();
                if (web3.utils.toBN(allowance).lt(web3.utils.toBN(feedCost))) {
                    await new web3.eth.Contract(erc20Abi, "0xe9Cb2D7ADC24Fc59FE00D6C0A0669BDF16805Fe0").methods.approve(contractAddress, feedCost).send({ from: account });
                }
                await contract.methods.batchFeedPet([petId]).send({ from: account });
                status.innerText = "Feeding successful!";
                dogMessage.innerText = getRandomMessage('feedSuccess');
                updatePets();
            } catch (error) {
                status.innerText = "Feeding failed: " + error.message;
                dogMessage.innerText = getRandomMessage('feedFail');
                console.error(error);
            } finally {
                feedButton.disabled = false;
                document.getElementById('feedLoading').style.display = 'none';
                modal.style.display = 'none';
            }
        }

        const erc20Abi = [
            {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},
            {"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"success","type":"bool"}],"type":"function"},
            {"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"remaining","type":"uint256"}],"type":"function"}
        ];
    </script>
</body>
</html>
